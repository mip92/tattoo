# Tattoo App - Automated Deployment Guide

## 🚀 Автоматизированный деплой приложения

Этот репозиторий содержит **инфраструктуру и автоматизацию** для деплоя Tattoo App на DigitalOcean сервер.

**🎯 Основная цель**: Полностью автоматизированный деплой без ручных команд!

## ⚠️ Важно: Настройка всех репозиториев

Для полной автоматизации необходимо настроить **ТРИ репозитория**:

1. **`tattoo-nginx`** (этот) - инфраструктура и автоматический деплой ✅
2. **`tclient`** - автоматическая сборка frontend образов ⚠️
3. **`tserver`** - автоматическая сборка backend образов ⚠️

**📋 Инструкции по настройке соседних репозиториев**: [REPOSITORIES_SETUP.md](./REPOSITORIES_SETUP.md)

## 🏗️ Архитектура автоматизации

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Frontend      │───▶│  GitHub Actions │───▶│   Docker Hub    │
│   Repository    │    │  (tclient)      │    │   Images        │
│   (tclient)     │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                       │
┌─────────────────┐             │                       │
│   Backend       │─────────────┘                       │
│   Repository    │                                     │
│   (tserver)     │                                     │
└─────────────────┘                                     │
                                │                       ▼
                                ▼                ┌─────────────────┐
                       ┌─────────────────┐      │   Docker Hub    │
                       │  Infrastructure │◀─────│   Images        │
                       │  Repository     │      └─────────────────┘
                       │  (tattoo-nginx) │
                       └─────────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │  DigitalOcean   │
                       │     Server      │
                       └─────────────────┘
```

## 🔄 Как работает автоматизация

### 1. **Frontend обновления** (репозиторий `tclient`)

- При мерже в `main` → автоматическая сборка Docker образа

- Образ пушится в Docker Hub
- **Этот репозиторий** автоматически обнаруживает обновления и деплоит frontend

### 2. **Backend обновления** (репозиторий `tserver`)

- При мерже в `main` → автоматическая сборка Docker образа
- Образ пушится в Docker Hub
- **Этот репозиторий** автоматически обнаруживает обновления и деплоит backend

### 3. **Инфраструктурные изменения** (этот репозиторий)

- При мерже в `main` → полный передеплой всей инфраструктуры
- Обновление конфигурации, Nginx, переменных окружения

## 📁 Структура проекта

```
tattoo-nginx/
├── .github/workflows/           # GitHub Actions для автоматического деплоя
│   ├── deploy-infrastructure.yml # Полный деплой инфраструктуры
│   ├── deploy-frontend.yml      # Автоматический деплой frontend
│   └── deploy-backend.yml       # Автоматический деплой backend
├── docker-compose.prod.yml      # Продакшн конфигурация
├── nginx/                       # Nginx конфигурация
├── REPOSITORIES_SETUP.md        # Инструкция по настройке соседних репозиториев
├── GITHUB_SECRETS_SETUP.md      # Инструкция по настройке secrets
└── README.md                    # Этот файл
```

## 🚀 Что происходит автоматически

### **При мерже в main любого репозитория:**

1. **Frontend мерж** → автоматический деплой frontend на сервер
2. **Backend мерж** → автоматический деплой backend на сервер
3. **Infrastructure мерж** → полный передеплой всей системы

### **По расписанию (каждые 10 минут):**

- Проверка обновлений Docker образов
- Автоматический деплой при обнаружении новых версий

## 🔧 Настройка автоматизации

### Шаг 1: Настройка этого репозитория

Следуйте инструкции в [GITHUB_SECRETS_SETUP.md](./GITHUB_SECRETS_SETUP.md)

### Шаг 2: Настройка соседних репозиториев

Следуйте инструкции в [REPOSITORIES_SETUP.md](./REPOSITORIES_SETUP.md)

### Шаг 3: Проверка работы

1. Перейдите в **Actions** в каждом репозитории
2. Выберите любой workflow
3. Нажмите **"Run workflow"**

### Шаг 4: Тестирование

- Сделайте тестовый коммит в main каждого репозитория
- Проверьте автоматический запуск деплоя
- Убедитесь, что все сервисы работают

## 🎯 Преимущества новой системы

✅ **Полная автоматизация** - никаких ручных команд  
✅ **Безопасность** - деплой только после мержа в main  
✅ **Мониторинг** - все деплои логируются в GitHub Actions  
✅ **Откат** - легко вернуться к предыдущей версии  
✅ **Разделение ответственности** - каждый репозиторий отвечает за свою часть

## 📊 Мониторинг деплоев

### GitHub Actions Dashboard

- Все деплои отображаются в разделе **Actions**
- Детальные логи каждого этапа
- Статус выполнения (успех/ошибка)

### Автоматические уведомления

- Успешный деплой → ✅ зеленый статус
- Ошибка деплоя → ❌ красный статус с деталями
- Health checks → автоматическая проверка работоспособности

## 🚨 Что делать при проблемах

### 1. **Проверить логи GitHub Actions**

- Перейти в Actions → выбрать workflow → посмотреть логи

### 2. **Проверить статус сервера**

```bash
ssh root@164.92.133.111 "docker ps"
```

### 3. **Запустить деплой вручную**

- В GitHub Actions → выбрать workflow → "Run workflow"

### 4. **Проверить secrets**

- Убедиться, что все secrets настроены правильно
- Проверить SSH ключ на сервере

## 🔄 Ручной деплой (если нужно)

### Полный передеплой инфраструктуры:

```bash
# В GitHub Actions → "Deploy Infrastructure" → "Run workflow"
```

### Деплой только frontend:

```bash
# В GitHub Actions → "Deploy Frontend" → "Run workflow"
```

### Деплой только backend:

```bash
# В GitHub Actions → "Deploy Backend" → "Run workflow"
```

## 📝 Чек-лист настройки

### В этом репозитории (tattoo-nginx):

- [ ] Настроены GitHub Secrets (`SERVER_IP`, `SERVER_USER`, `SSH_PRIVATE_KEY`)
- [ ] SSH ключ добавлен на сервер
- [ ] Протестирован первый автоматический деплой

### В репозитории tclient (frontend):

- [ ] Создана папка `.github/workflows/`
- [ ] Настроены secrets (`DOCKERHUB_USERNAME`, `DOCKERHUB_TOKEN`)
- [ ] Протестирована автоматическая сборка

### В репозитории tserver (backend):

- [ ] Создана папка `.github/workflows/`
- [ ] Настроены secrets (`DOCKERHUB_USERNAME`, `DOCKERHUB_TOKEN`)
- [ ] Протестирована автоматическая сборка

### Общие проверки:

- [ ] Проверена работа всех сервисов
- [ ] Настроены уведомления (опционально)
- [ ] Протестирован полный цикл автоматизации

## 🎉 Результат

После настройки у вас будет:

- 🚀 **Полностью автоматизированный деплой**
- 📊 **Мониторинг всех процессов**
- 🔒 **Безопасная система обновлений**
- 📈 **Масштабируемая инфраструктура**

**Время настройки**: ~30 минут (все три репозитория)  
**Время деплоя**: ~2-5 минут  
**Автоматизация**: 100%

---

## 📞 Поддержка

При возникновении проблем:

1. Проверьте логи в GitHub Actions
2. Убедитесь в правильности secrets
3. Проверьте статус сервера
4. При необходимости запустите деплой вручную

**🎯 Теперь вы можете просто мержить код в main и получать автоматический деплой!**
