#!/bin/bash

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -f "docker-hub.env" ]; then
    source docker-hub.env
else
    echo "‚ö†Ô∏è  –§–∞–π–ª docker-hub.env –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é."
    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    REGISTRY="docker.io"
    USERNAME="mip92"
    IMAGE_NAME="tattoo-server"
    TAG="latest"
fi

echo "üöÄ –î–µ–ø–ª–æ—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä (—Ç–æ–ª—å–∫–æ pull –∏ –∑–∞–ø—É—Å–∫)..."

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "üì¶ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Ç–µ–∫—É—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker-compose -f docker-compose.prod.yml down

# –û—á–∏—â–∞–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã
echo "üßπ –û—á–∏—â–∞—é –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã..."
docker system prune -f

# –¢—è–Ω–µ–º –≥–æ—Ç–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã –∏–∑ registry
echo "üì• –¢—è–Ω—É backend –æ–±—Ä–∞–∑ –∏–∑ registry..."
docker pull ${REGISTRY}/${USERNAME}/${IMAGE_NAME}:${TAG}
if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ backend –æ–±—Ä–∞–∑–∞!"
    exit 1
fi
echo "‚úÖ Backend –æ–±—Ä–∞–∑ –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ!"

echo "üì• –¢—è–Ω—É frontend –æ–±—Ä–∞–∑ –∏–∑ registry..."
docker pull ${REGISTRY}/${USERNAME}/tattoo-client:${TAG}
if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ frontend –æ–±—Ä–∞–∑–∞!"
    exit 1
fi
echo "‚úÖ Frontend –æ–±—Ä–∞–∑ –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ!"

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å—ã..."
docker-compose -f docker-compose.prod.yml up -d

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤!"
    exit 1
fi

echo "‚úÖ –°–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
echo "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤:"
docker stats --no-stream

echo ""
echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω! –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –≥–æ—Ç–æ–≤—ã–º–∏ –æ–±—Ä–∞–∑–∞–º–∏."
echo "üí° –†–µ—Å—É—Ä—Å—ã —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ—Ç—Ä–∞—á–µ–Ω—ã —Ç–æ–ª—å–∫–æ –Ω–∞:"
echo "   - –ó–∞–≥—Ä—É–∑–∫—É –æ–±—Ä–∞–∑–æ–≤ (docker pull)"
echo "   - –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
echo "   - –ù–ï –Ω–∞ —Å–±–æ—Ä–∫—É!"
