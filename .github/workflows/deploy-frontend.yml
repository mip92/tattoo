name: Deploy Frontend

on:
  workflow_dispatch: # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  repository_dispatch: # –°–æ–±—ã—Ç–∏–µ –æ—Ç tclient —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    types: [deploy-frontend]

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Get frontend image info
        id: image-info
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–æ–≤–æ–º –æ–±—Ä–∞–∑–µ –∏–∑ payload
          FRONTEND_IMAGE="${{ github.event.client_payload.frontend_image }}"
          echo "frontend_image=$FRONTEND_IMAGE" >> $GITHUB_OUTPUT
          echo "üöÄ Deploying frontend image: $FRONTEND_IMAGE"

      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üöÄ Deploying updated frontend..."

            cd /root/tattoo-app

            # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º frontend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            echo "‚èπÔ∏è Force stopping and removing frontend container..."
            docker-compose -f docker-compose.prod.yml down frontend
            docker rm -f tattoo-frontend-prod || true

            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–∑ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ)
            echo "üóëÔ∏è Force removing old frontend image..."
            docker rmi -f mip92/tattoo-client:latest || true

            # –û—á–∏—â–∞–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã
            echo "üßπ Cleaning up unused images..."
            docker image prune -f

            # –ó–∞–ø—É—Å–∫–∞–µ–º frontend —Å –Ω–æ–≤—ã–º –æ–±—Ä–∞–∑–æ–º
            echo "üîÑ Starting frontend with new image..."
            docker-compose -f docker-compose.prod.yml up -d frontend

            # –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            echo "‚è≥ Waiting for frontend to initialize..."
            sleep 20

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "üìä Checking frontend status..."
            docker ps | grep frontend

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑
            echo "üîç Checking image hash..."
            docker inspect mip92/tattoo-client:latest --format='{{.Id}}' || echo "New image not found"

            echo "‚úÖ Frontend deployment completed!"

      - name: Health check frontend
        run: |
          echo "üîç Testing frontend health..."
          sleep 10

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º main page
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_IP }}/)

          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ Frontend is healthy (HTTP $RESPONSE)"
          else
            echo "‚ùå Frontend health check failed (HTTP $RESPONSE)"
            exit 1
          fi
