name: Deploy Frontend

on:
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * *" # –ö–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

jobs:
  check-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Check for frontend image updates
        id: check-image
        run: |
          # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π digest –æ–±—Ä–∞–∑–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
          CURRENT_DIGEST=$(ssh -o StrictHostKeyChecking=no -i ${{ secrets.SSH_PRIVATE_KEY }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "docker images --digests --format '{{.Digest}}' mip92/tattoo-client:latest | head -1")

          # –ü–æ–ª—É—á–∞–µ–º digest –∏–∑ Docker Hub
          HUB_DIGEST=$(docker manifest inspect mip92/tattoo-client:latest | jq -r '.manifests[] | select(.platform.architecture == "amd64") | .digest')

          echo "Current digest: $CURRENT_DIGEST"
          echo "Hub digest: $HUB_DIGEST"

          if [ "$CURRENT_DIGEST" != "$HUB_DIGEST" ]; then
            echo "::set-output name=needs_update::true"
            echo "üîÑ Frontend image needs update"
          else
            echo "::set-output name=needs_update::false"
            echo "‚úÖ Frontend image is up to date"
          fi

      - name: Deploy frontend if updated
        if: steps.check-image.outputs.needs_update == 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üöÄ Deploying updated frontend..."

            cd /root/tattoo-app

            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º frontend
            echo "‚èπÔ∏è Stopping frontend service..."
            docker-compose -f docker-compose.prod.yml stop frontend

            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–∑
            echo "üóëÔ∏è Removing old frontend image..."
            docker rmi mip92/tattoo-client:latest || true

            # –ó–∞–ø—É—Å–∫–∞–µ–º frontend —Å –Ω–æ–≤—ã–º –æ–±—Ä–∞–∑–æ–º
            echo "üîÑ Starting frontend with new image..."
            docker-compose -f docker-compose.prod.yml up -d frontend

            # –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            echo "‚è≥ Waiting for frontend to initialize..."
            sleep 20

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "üìä Checking frontend status..."
            docker ps | grep frontend

            echo "‚úÖ Frontend deployment completed!"

      - name: Health check frontend
        if: steps.check-image.outputs.needs_update == 'true'
        run: |
          echo "üîç Testing frontend health..."
          sleep 10

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º main page
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_IP }}/)

          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ Frontend is healthy (HTTP $RESPONSE)"
          else
            echo "‚ùå Frontend health check failed (HTTP $RESPONSE)"
            exit 1
          fi
