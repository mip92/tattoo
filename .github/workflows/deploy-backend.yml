name: Deploy Backend

on:
  workflow_dispatch: # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  repository_dispatch: # –°–æ–±—ã—Ç–∏–µ –æ—Ç tserver —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    types: [deploy-backend]

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Get backend image info
        id: image-info
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–æ–≤–æ–º –æ–±—Ä–∞–∑–µ –∏–∑ payload
          BACKEND_IMAGE="${{ github.event.client_payload.backend_image }}"
          echo "backend_image=$BACKEND_IMAGE" >> $GITHUB_OUTPUT
          echo "üöÄ Deploying backend image: $BACKEND_IMAGE"

      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üöÄ Deploying updated backend..."

            cd /root/tattoo-app

            # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º backend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            echo "‚èπÔ∏è Force stopping and removing backend container..."
            docker-compose -f docker-compose.prod.yml down backend
            docker rm -f tattoo-backend-prod || true

            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–∑ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ)
            echo "üóëÔ∏è Force removing old backend image..."
            docker rmi -f mip92/tattoo-server:latest || true

            # –û—á–∏—â–∞–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã
            echo "üßπ Cleaning up unused images..."
            docker image prune -f

            # –ó–∞–ø—É—Å–∫–∞–µ–º backend —Å –Ω–æ–≤—ã–º –æ–±—Ä–∞–∑–æ–º
            echo "üîÑ Starting backend with new image..."
            docker-compose -f docker-compose.prod.yml up -d backend

            # –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            echo "‚è≥ Waiting for backend to initialize..."
            sleep 30

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "üìä Checking backend status..."
            docker ps | grep backend

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑
            echo "üîç Checking image hash..."
            docker inspect mip92/tattoo-server:latest --format='{{.Id}}' || echo "New image not found"

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º health check
            echo "üíö Checking backend health..."
            docker-compose -f docker-compose.prod.yml ps | grep backend

            echo "‚úÖ Backend deployment completed!"

      - name: Health check backend
        run: |
          echo "üîç Testing backend health..."
          sleep 15

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º GraphQL endpoint
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_IP }}/graphql)

          if [ "$RESPONSE" = "400" ] || [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ Backend is healthy (HTTP $RESPONSE - CSRF protection working)"
          else
            echo "‚ùå Backend health check failed (HTTP $RESPONSE)"
            exit 1
          fi
