name: Deploy Backend

on:
  workflow_dispatch: # Manual trigger
  repository_dispatch: # Event from tserver repository
    types: [deploy-backend]

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Get backend image info
        id: image-info
        run: |
          # Get information about new image from payload
          BACKEND_IMAGE="${{ github.event.client_payload.backend_image }}"
          echo "backend_image=$BACKEND_IMAGE" >> $GITHUB_OUTPUT
          echo "ğŸš€ Deploying backend image: $BACKEND_IMAGE"

      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ Deploying updated backend..."

            cd /root/tattoo-app

            # Force stop and remove backend container
            echo "â¹ï¸ Force stopping and removing backend container..."
            docker-compose -f docker-compose.prod.yml down backend
            docker rm -f tattoo-backend-prod || true

            # Remove old image (force)
            echo "ğŸ—‘ï¸ Force removing old backend image..."
            docker rmi -f mip92/tattoo-server:latest || true

            # Clean up unused images
            echo "ğŸ§¹ Cleaning up unused images..."
            docker image prune -f

            # Start backend with new image
            echo "ğŸ”„ Starting backend with new image..."
            docker-compose -f docker-compose.prod.yml up -d backend

            # Wait for initialization
            echo "â³ Waiting for backend to initialize..."
            sleep 30

            # Check status
            echo "ğŸ“Š Checking backend status..."
            docker ps | grep backend

            # Check that new image is being used
            echo "ğŸ” Checking image hash..."
            docker inspect mip92/tattoo-server:latest --format='{{.Id}}' || echo "New image not found"

            # Check health check
            echo "ğŸ’š Checking backend health..."
            docker-compose -f docker-compose.prod.yml ps | grep backend

            echo "âœ… Backend deployment completed!"

      - name: Health check backend
        run: |
          echo "ğŸ” Testing backend health..."
          sleep 15

          # Check GraphQL endpoint
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_IP }}/graphql)

          if [ "$RESPONSE" = "400" ] || [ "$RESPONSE" = "200" ]; then
            echo "âœ… Backend is healthy (HTTP $RESPONSE - CSRF protection working)"
          else
            echo "âŒ Backend health check failed (HTTP $RESPONSE)"
            exit 1
          fi
