name: üöÄ Deploy to DigitalOcean

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [closed]

jobs:
  deploy:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest

    steps:
      - name: üöÄ Deploy to DigitalOcean
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DIGITALOCEAN_HOST }}
          username: ${{ secrets.DIGITALOCEAN_USER }}
          key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}
          port: 22
          script: |
            echo "üöÄ Starting deployment..."
            cd ~/tattoo-app

            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            echo "‚èπÔ∏è  Stopping current application..."
            docker-compose -f docker-compose.prod.yml down || true

            # –û–±–Ω–æ–≤–ª—è–µ–º backend —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
            echo "üì• Updating backend..."
            if [ -d "backend" ]; then
              cd backend
              git fetch origin
              git reset --hard origin/main
              cd ..
            else
              echo "‚ùå Backend directory not found"
              exit 1
            fi

            # –û–±–Ω–æ–≤–ª—è–µ–º frontend —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
            echo "üì• Updating frontend..."
            if [ -d "frontend" ]; then
              cd frontend
              git fetch origin
              git reset --hard origin/main
              cd ..
            else
              echo "‚ùå Frontend directory not found"
              exit 1
            fi

            # –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º
            echo "üî® Rebuilding and starting application..."
            docker-compose -f docker-compose.prod.yml build --no-cache
            docker-compose -f docker-compose.prod.yml up -d

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "üîç Checking application status..."
            docker-compose -f docker-compose.prod.yml ps

            echo "‚úÖ Deployment completed successfully!"

      - name: üîç Health Check
        if: success()
        run: |
          echo "Waiting for application to start..."
          sleep 30

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API
          if curl -f http://${{ secrets.DIGITALOCEAN_HOST }}/health; then
            echo "‚úÖ API is healthy"
          else
            echo "‚ùå API health check failed"
            exit 1
          fi

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
          if curl -f http://${{ secrets.DIGITALOCEAN_HOST }}/; then
            echo "‚úÖ Frontend is accessible"
          else
            echo "‚ùå Frontend check failed"
            exit 1
          fi
